<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Socket.IO Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { margin:0; font-family:system-ui, sans-serif; }
      #chat { display:flex; flex-direction:column; height:100vh; }
      header { display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-bottom:1px solid #eee; }
      header input { padding:.4rem .6rem; }
      ul#messages { list-style:none; margin:0; padding:0; flex:1; overflow:auto; }
      ul#messages li { padding:8px 12px; border-bottom:1px solid #eee; }
      ul#messages li.me { opacity:.75; }
      ul#messages li.system { font-style:italic; opacity:.7; }
      form { display:flex; gap:8px; padding:8px; border-top:1px solid #eee; }
      input[type=text] { flex:1; padding:10px; }
      button { padding:10px 14px; cursor:pointer; }
      small.time { opacity:.6; margin-left:8px; }
    </style>
  </head>
  <body>
    <div id="chat">
      <header>
        <label for="name">Name:</label>
        <input id="name" placeholder="e.g., Eric" />
        <button id="setNameBtn" type="button">Set</button>
      </header>

      <ul id="messages"></ul>

      <form id="form" autocomplete="off">
        <input id="input" type="text" placeholder="Type a message…" />
        <button type="submit">Send</button>
      </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let myId = null;
      let myName = '';

      const $name = document.getElementById('name');
      const $setNameBtn = document.getElementById('setNameBtn');
      const $messages = document.getElementById('messages');
      const $form = document.getElementById('form');
      const $input = document.getElementById('input');

      socket.on('connect', () => {
        myId = socket.id;
        // default placeholder until user clicks Set
        myName = `User-${myId.slice(0,4)}`;
        socket.emit('join', myName);
        $name.value = '';
      });

      $setNameBtn.addEventListener('click', () => {
        const n = ($name.value || '').trim();
        if (!n) return;
        myName = n;
        socket.emit('join', myName);
      });

      $form.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = $input.value.trim();
        if (!text) return;
        socket.emit('chat message', text);
        $input.value = '';
        $input.focus();
      });

      function addMessage(text, isMe, label, ts, type='user') {
        const li = document.createElement('li');
        if (type === 'system') li.className = 'system';
        if (isMe) li.classList.add('me');

        li.textContent = type === 'system'
          ? text
          : `${isMe ? \`You (${myName})\` : label}: ${text}`;

        if (ts) {
          const time = document.createElement('small');
          time.className = 'time';
          time.textContent = new Date(ts).toLocaleTimeString();
          li.appendChild(time);
        }
        $messages.appendChild(li);
        $messages.scrollTop = $messages.scrollHeight;
      }

      socket.on('chat message', (payload) => {
        const isMe = payload.id === myId;
        addMessage(payload.msg, isMe, payload.name, payload.ts);
      });

      socket.on('system', (text) => {
        addMessage(text, false, '', null, 'system');
      });
    </script>
  </body>
</html>
